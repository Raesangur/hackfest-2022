const gatttool = require("../src/index");
const { Writable } = require("stream");

const ble = new Writable({
  objectMode: true,
  write: (data, encoding, done) => {
    console.log(`[stream] ←${data.toString(encoding)}`);
    done();
  }
});

const handleData = data => console.log(`[onData] ←${data}`);

(async function() {
  gatttool.start({ onData: handleData, stream: ble });

  const btAddress = await gatttool.scanFor("FooBar2", 1);
  console.log(`Found a BT device at: ${btAddress}`);

  if (btAddress) {
    try {
      console.log("Connecting...");
      const device = await gatttool.connect(btAddress);
      console.log("Successfully connected");

      console.log("Discovering...");
      await device.discovery();
      console.log("Discovery completed");
      console.log("device.chars", device.chars);
      // await dev.write(12, "NODEJS");

      // setTimeout(
      //   () => gatttool.write("char-write-cmd 0x0012 4e4f44454a53"),
      //   10000
      // );
      // setTimeout(() => gatttool.write("exit"), 15000);
      await gatttool.end();
    } catch (err) {
      console.error(err, `Error occured while interacting with a device`);
      process.exit();
    }

    process.exit();
  }
})();
